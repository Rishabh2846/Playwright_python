from behave import given, when, then
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.chrome.service import Service as ChromeService
from selenium.webdriver.common.action_chains import ActionChains
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC

@given('I am on the hover page')
def step_impl(context):
    service = ChromeService()
    options = webdriver.ChromeOptions()
    context.driver = webdriver.Chrome(service=service, options=options)
    context.driver.get("https://practice.expandtesting.com/hovers")

@when('I hover over user {user_num}')
def step_impl(context, user_num):
    img = context.driver.find_element(By.CSS_SELECTOR, f"img[data-testid='img-user-{user_num}']")
    ActionChains(context.driver).move_to_element(img).perform()

@then('I should see "{expected}"')
def step_impl(context, expected):
    WebDriverWait(context.driver, 5).until(
        EC.visibility_of_element_located((By.TAG_NAME, "h5"))
    )
    assert expected in context.driver.page_source

@when('I hover over user {user_num} and click the link')
def step_impl(context, user_num):
    img = context.driver.find_element(By.CSS_SELECTOR, f"img[data-testid='img-user-{user_num}']")
    ActionChains(context.driver).move_to_element(img).perform()
    link = context.driver.find_element(By.CSS_SELECTOR, f"a[href='/users/{user_num}']")
    link.click()

@then('I should see "Welcome user{user_num}"')
def step_impl(context, user_num):
    WebDriverWait(context.driver, 5).until(
        EC.visibility_of_element_located((By.TAG_NAME, "h2"))
    )
    assert f"Welcome user{user_num}" in context.driver.page_source
    context.driver.back()

